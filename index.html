<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus Task Tracker</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#000;
  color:#fff;
  display:flex;
}
.left{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  width:420px;
  background:#0b0b0b;
  border:1px solid #222;
  border-radius:18px;
  padding:30px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
}
.stats{
  display:flex;
  gap:20px;
}
.stat{
  width:140px;height:140px;
  border:1px solid #444;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
.stat-value{font-size:40px;font-weight:800}
.timer{
  font-size:36px;
  font-weight:700;
}
button{
  padding:14px 22px;
  border-radius:14px;
  border:none;
  font-weight:600;
  color:#fff;
  cursor:pointer;
}
.start{background:#16a34a}
.stop{background:#dc2626}
.submit{background:#2563eb}
</style>
</head>

<body>

<div class="left">
  <div class="card">

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="count">0</div>
        <div>Tasks</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalTime">00:00</div>
        <div>Time</div>
      </div>
    </div>

    <div class="timer" id="timer">00:00</div>

    <input id="taskName" placeholder="Task name">
    <input id="timeInput" type="number" placeholder="Minutes">

    <button class="start" onclick="startTimer()">Start</button>
    <button class="submit" onclick="submitTask()">Submit</button>
    <button class="stop" onclick="stopTimer()">Stop</button>

  </div>
</div>

<audio id="alarm" src="iphone_alarm.mp3" loop preload="auto"></audio>

<script>
let endTime = null;
let timeoutId = null;
let startTime = null;
let totalTasks = 0;
let totalTime = 0;

const alarm = document.getElementById("alarm");

function format(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function unlockAudio(){
  alarm.muted = true;
  alarm.play().then(()=>{
    alarm.pause();
    alarm.muted = false;
  }).catch(()=>{});
}

function startTimer(){
  unlockAudio();

  const mins = Number(timeInput.value);
  if(!mins || mins <= 0) return;

  startTime = Date.now();
  endTime = startTime + mins * 60 * 1000;

  scheduleEnd();
  updateDisplay();
}

function scheduleEnd(){
  clearTimeout(timeoutId);

  const remaining = endTime - Date.now();

  if(remaining <= 0){
    finishTimer();
    return;
  }

  timeoutId = setTimeout(finishTimer, remaining);
}

function updateDisplay(){
  if(!endTime) return;

  const remaining = Math.max(0, Math.ceil((endTime - Date.now())/1000));
  timer.innerText = format(remaining);

  if(remaining > 0){
    requestAnimationFrame(updateDisplay);
  }
}

function finishTimer(){
  if(!endTime) return;

  alarm.currentTime = 0;
  alarm.play();

  autoSubmit();
}

function autoSubmit(){
  totalTasks++;
  count.innerText = totalTasks;

  const spent = Math.round((Date.now() - startTime)/1000);
  totalTime += spent;
  totalTimeEl.innerText = format(totalTime);

  endTime = null;
}

function submitTask(){
  if(!startTime) return;
  autoSubmit();
  stopTimer();
}

function stopTimer(){
  clearTimeout(timeoutId);
  timeoutId = null;
  endTime = null;
  alarm.pause();
  alarm.currentTime = 0;
  timer.innerText = "00:00";
}

/* ðŸ”¥ CRITICAL: handle tab returning */
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden && endTime){
    scheduleEnd();
    updateDisplay();
  }
});

const totalTimeEl = document.getElementById("totalTime");
</script>

</body>
</html>
